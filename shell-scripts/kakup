session-or-client() {
        {
            pushd $(cat -)
	    DIRSTACK
            export servers=kakoune-servers-${USER}
            export name=${PWD#$HOME/}
            export name=${name//\//-}
            export client=kakoune@$name

            tmux has-session -t $servers || tmux new -d -s $servers kak -s $name -d\; rename-window $name
            tmux list-windows -t $servers -F "#{window_name}" | grep $name || tmux new-window -t $servers -n $name -d kak -s $name -d
	    if [[ -z $TMUX ]]; then
                tmux has-session -t $client || tmux new -d -s $client -n $name kak -c $name
	    else
    	    	tmux new-window -n $name kak -c $name
            fi
            popd
        } </dev/stdin >/dev/null 2>&1
        echo $client
}

client="$(fd -d1 "." -t d $HOME $HOME/projects | fzf | session-or-client)"
echo "client: $client"
tmux attach -t "$client"
